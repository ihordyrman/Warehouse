sequenceDiagram
    autonumber
    participant O as Orchestrator.Worker
    participant E as Executor.T
    participant B as Builder
    participant R as Registry.T
    participant Run as Runner
    participant S as Step<'ctx>
    participant C as TradingContext

    rect rgb(40, 60, 40)
        Note over O, E: Startup Phase
        O ->> O: loadAllPipelines(db)
        O ->> E: Executor.create(services, registry, logger, pipelineId)
        O ->> E: executor.Start(ct)
        E ->> E: executeLoop starts
    end

    rect rgb(40, 40, 60)
        Note over E, C: Execution Loop (repeats every ExecutionInterval)
        loop While not cancelled
            E ->> E: loadPipeline(db, pipelineId)
            E ->> B: buildSteps(registry, services, stepConfigs)
            B ->> R: tryFind(stepTypeKey)
            R -->> B: StepDefinition option
            B ->> B: Parameters.validate(schema, params)
            B ->> B: definition.Create(validParams, services)
            B -->> E: Result<Step list, BuildError list>
            E ->> E: CandlestickStore.GetLatest(symbol)
            E ->> C: createContext(pipeline, price, marketData)
            E ->> Run: run(steps, context, ct)
            loop For each step
                Run ->> S: step(context, ct)
                S ->> C: Read/transform context
                S -->> Run: StepResult<'ctx>
                alt Continue(ctx', message)
                    Run ->> Run: currentCtx = ctx'
                else Stop(message)
                    Note over Run: Break loop
                else Fail(error)
                    Note over Run: Break loop
                end
            end
            Run -->> E: Final StepResult
            E ->> E: Task.Delay(interval, ct)
        end
    end

    rect rgb(60, 40, 40)
        Note over O, E: Shutdown / Sync Phase
        O ->> O: synchronize(services, ct)
        alt Pipeline should stop
            O ->> E: executor.Stop()
            E ->> E: Cancel CTS & await task
        end
    end
